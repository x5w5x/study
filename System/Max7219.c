#include"stm32f10x.h"
#include"Delay.h"
#define SPI_IS_HARDWARE 0 //(1:硬件SPI 0:软件SPI)



//字库数据
u8 code_disp1[38][8]={
{0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//0
{0x08,0x18,0x28,0x08,0x08,0x08,0x08,0x3E},//1
{0x7E,0x02,0x02,0x7E,0x40,0x40,0x40,0x7E},//2
{0x3E,0x02,0x02,0x3E,0x02,0x02,0x3E,0x00},//3
{0x08,0x18,0x28,0x48,0xFE,0x08,0x08,0x08},//4
{0x3C,0x20,0x20,0x3C,0x04,0x04,0x3C,0x00},//5
{0x3C,0x20,0x20,0x3C,0x24,0x24,0x3C,0x00},//6
{0x3E,0x22,0x04,0x08,0x08,0x08,0x08,0x08},//7
{0x00,0x3E,0x22,0x22,0x3E,0x22,0x22,0x3E},//8
{0x3E,0x22,0x22,0x3E,0x02,0x02,0x02,0x3E},//9
{0x08,0x14,0x22,0x3E,0x22,0x22,0x22,0x22},//A
{0x3C,0x22,0x22,0x3E,0x22,0x22,0x3C,0x00},//B
{0x3C,0x40,0x40,0x40,0x40,0x40,0x3C,0x00},//C
{0x7C,0x42,0x42,0x42,0x42,0x42,0x7C,0x00},//D
{0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x7C},//E
{0x7C,0x40,0x40,0x7C,0x40,0x40,0x40,0x40},//F
{0x3C,0x40,0x40,0x40,0x40,0x44,0x44,0x3C},//G
{0x44,0x44,0x44,0x7C,0x44,0x44,0x44,0x44},//H
{0x7C,0x10,0x10,0x10,0x10,0x10,0x10,0x7C},//I
{0x3C,0x08,0x08,0x08,0x08,0x08,0x48,0x30},//J
{0x00,0x24,0x28,0x30,0x20,0x30,0x28,0x24},//K
{0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x7C},//L
{0x81,0xC3,0xA5,0x99,0x81,0x81,0x81,0x81},//M
{0x00,0x42,0x62,0x52,0x4A,0x46,0x42,0x00},//N
{0x3C,0x42,0x42,0x42,0x42,0x42,0x42,0x3C},//O
{0x3C,0x22,0x22,0x22,0x3C,0x20,0x20,0x20},//P
{0x1C,0x22,0x22,0x22,0x22,0x26,0x22,0x1D},//Q
{0x3C,0x22,0x22,0x22,0x3C,0x24,0x22,0x21},//R
{0x00,0x1E,0x20,0x20,0x3E,0x02,0x02,0x3C},//S
{0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08},//T
{0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x1C},//U
{0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x18},//V
{0x00,0x49,0x49,0x49,0x49,0x2A,0x1C,0x00},//W
{0x81,0x42,0x24,0x18,0x18,0x24,0x42,0x81},//X
{0x41,0x22,0x14,0x08,0x08,0x08,0x08,0x08},//Y
{0x00,0x7F,0x02,0x04,0x08,0x10,0x20,0x7F},//Z
{0x08,0x7F,0x49,0x49,0x7F,0x08,0x08,0x08},//中
{0xFE,0xBA,0x92,0xBA,0x92,0x9A,0xBA,0xFE},//国
};

void Max7219_W_CS(uint8_t bitValue)
{
    GPIO_WriteBit(GPIOA,GPIO_Pin_3,(BitAction)bitValue); //CS
}

void Max7219_W_CLK(uint8_t bitValue)
{
    GPIO_WriteBit(GPIOA,GPIO_Pin_5,(BitAction)bitValue); //CLK
}

void Max7219_W_DIN(uint8_t bitValue)
{
    GPIO_WriteBit(GPIOA,GPIO_Pin_7,(BitAction)bitValue); //DIN
}




#if SPI_IS_HARDWARE //使用硬件SPI


/* 完全保持原有函数实现 */
void Max7219_GPIO_Init(void)
 {
    
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_AFIO|RCC_APB2Periph_GPIOA, ENABLE);//使能GPIOA时钟
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_SPI1,ENABLE);//使能SPI1时钟

    SPI_InitTypeDef  SPI1_InitStructure;//SPI1初始化结构体
    GPIO_InitTypeDef GPIO_InitStructure;//GPIO初始化结构体
     
   
    // SPI1引脚配置
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
    GPIO_Init(GPIOA,&GPIO_InitStructure);
    //
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_5|GPIO_Pin_7;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_AF_PP;
    GPIO_Init(GPIOA,&GPIO_InitStructure);
     //SPI1配置
    SPI1_InitStructure.SPI_Direction = SPI_Direction_2Lines_FullDuplex;
    SPI1_InitStructure.SPI_BaudRatePrescaler = SPI_BaudRatePrescaler_64;
    SPI1_InitStructure.SPI_DataSize = SPI_DataSize_8b;
    SPI1_InitStructure.SPI_Mode = SPI_Mode_Master;
    SPI1_InitStructure.SPI_FirstBit = SPI_FirstBit_MSB;
    SPI1_InitStructure.SPI_CPOL = SPI_CPOL_High;					
    SPI1_InitStructure.SPI_CPHA = SPI_CPHA_2Edge;
    SPI1_InitStructure.SPI_NSS = SPI_NSS_Soft; 
    SPI1_InitStructure.SPI_CRCPolynomial = 7;
    // SPI1初始化
    SPI_I2S_DeInit(SPI1);
    SPI_Init(SPI1, &SPI1_InitStructure); 
    SPI_Cmd(SPI1, ENABLE);
}

void Max7219_Write(u8 addr,u8 dat) {
    Max7219_W_CS(0);
    SPI_I2S_SendData(SPI1, addr);
    Delay_us(10);
    SPI_I2S_SendData(SPI1, dat);
    Delay_us(10);
    Max7219_W_CS(1);
}
#else


void Max7219_GPIO_Init(void)
{
    RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOA,ENABLE);
    GPIO_InitTypeDef GPIO_InitStructure;
    GPIO_InitStructure.GPIO_Pin = GPIO_Pin_3|GPIO_Pin_5|GPIO_Pin_7;
    GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_PP;
    GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
    GPIO_Init(GPIOA,&GPIO_InitStructure);

}


void Max7219_Write_byte(uint8_t dat)
{
    uint8_t i;
    Max7219_W_CS(0);
    for(i=0;i<8;i++)
    {
        Max7219_W_CLK(0);
        if(dat&0x80)
        {
            Max7219_W_DIN(1);
        }
        else
        {
            Max7219_W_DIN(0);
        }
        dat<<=1;
        Max7219_W_CLK(1);
        }
    
}


void Max7219_Write(uint8_t addr,uint8_t dat)
{ Max7219_W_CS(0);
    Max7219_Write_byte(addr);
    Max7219_Write_byte(dat);
     Max7219_W_CS(1);
}

#endif


void Init_MAX7219(void) {
    Max7219_Write(0x09, 0x00);
    Max7219_Write(0x0a, 0x03);
    Max7219_Write(0x0b, 0x07);
    Max7219_Write(0x0c, 0x01);
    Max7219_Write(0x0f, 0x00);
}